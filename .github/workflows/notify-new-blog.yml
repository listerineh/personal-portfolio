name: Notify New Blog Post

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/lib/data/blog/*.ts'

jobs:
  notify-subscribers:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Set environment based on branch
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "is_production=true" >> $GITHUB_OUTPUT
            echo "environment=Production" >> $GITHUB_OUTPUT
          else
            echo "is_production=false" >> $GITHUB_OUTPUT
            echo "environment=Preview (develop)" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Detect new or modified blog files
        id: detect
        run: |
          # Get list of added or modified files in src/lib/data/blog/
          NEW_FILES=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD | grep '^src/lib/data/blog/.*\.ts$' || true)
          
          if [ -z "$NEW_FILES" ]; then
            echo "No new or modified blog files detected"
            echo "has_new_blog=false" >> $GITHUB_OUTPUT
          else
            echo "New or modified blog file(s) detected:"
            echo "$NEW_FILES"
            # Take the first file (in case multiple were changed)
            BLOG_FILE=$(echo "$NEW_FILES" | head -n 1)
            echo "blog_file=$BLOG_FILE" >> $GITHUB_OUTPUT
            echo "has_new_blog=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Extract blog data
        if: steps.detect.outputs.has_new_blog == 'true'
        id: extract
        run: |
          BLOG_FILE="${{ steps.detect.outputs.blog_file }}"
          echo "Extracting data from: $BLOG_FILE"
          
          # Extract blog data using the script
          BLOG_DATA=$(node scripts/extract-blog-data.js "$BLOG_FILE")
          
          # Parse JSON and set outputs
          TITLE=$(echo "$BLOG_DATA" | jq -r '.title')
          SLUG=$(echo "$BLOG_DATA" | jq -r '.slug')
          EXCERPT=$(echo "$BLOG_DATA" | jq -r '.excerpt')
          IMAGE_URL=$(echo "$BLOG_DATA" | jq -r '.imageUrl')
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "excerpt=$EXCERPT" >> $GITHUB_OUTPUT
          echo "image_url=$IMAGE_URL" >> $GITHUB_OUTPUT
          
          echo "ðŸ“§ Blog data extracted:"
          echo "   Title: $TITLE"
          echo "   Slug: $SLUG"
          echo "   Excerpt: ${EXCERPT:0:50}..."
          echo "   Image: $IMAGE_URL"
      
      - name: Send notification to subscribers (Production only)
        if: steps.detect.outputs.has_new_blog == 'true' && steps.env.outputs.is_production == 'true'
        env:
          SITE_URL: ${{ secrets.SITE_URL || 'https://listerineh.dev' }}
        run: |
          echo "ðŸ“§ Sending notification to subscribers..."
          
          # Call the notification API endpoint
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$SITE_URL/api/newsletter/send-blog-notification" \
            -H "Content-Type: application/json" \
            -d '{
              "blogTitle": "${{ steps.extract.outputs.title }}",
              "blogSlug": "${{ steps.extract.outputs.slug }}",
              "blogExcerpt": "${{ steps.extract.outputs.excerpt }}",
              "blogImageUrl": "${{ steps.extract.outputs.image_url }}"
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Notification sent successfully!"
            echo "$BODY" | jq '.'
          else
            echo "âŒ Failed to send notification (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi
      
      - name: Summary - Production
        if: steps.detect.outputs.has_new_blog == 'true' && steps.env.outputs.is_production == 'true'
        env:
          BLOG_TITLE: ${{ steps.extract.outputs.title }}
          BLOG_SLUG: ${{ steps.extract.outputs.slug }}
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“§ Blog Notification Sent
          
          EOF
          echo "**Environment:** $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** $BLOG_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "**Slug:** $BLOG_SLUG" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://listerineh.dev/blog/$BLOG_SLUG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          âœ… Subscribers have been notified! ðŸŽ‰
          EOF
      
      - name: Summary - Preview (Develop)
        if: steps.detect.outputs.has_new_blog == 'true' && steps.env.outputs.is_production == 'false'
        env:
          BLOG_TITLE: ${{ steps.extract.outputs.title }}
          BLOG_SLUG: ${{ steps.extract.outputs.slug }}
          BLOG_EXCERPT: ${{ steps.extract.outputs.excerpt }}
          BLOG_IMAGE: ${{ steps.extract.outputs.image_url }}
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“ New Blog Post Detected (Preview Mode)
          
          EOF
          echo "**Environment:** $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** $BLOG_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "**Slug:** $BLOG_SLUG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Excerpt:** $BLOG_EXCERPT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image URL:** $BLOG_IMAGE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ### ï¿½ What will happen when merged to main:
          
          - âœ‰ï¸ Email notifications will be sent to all subscribers
          - ðŸ“Š Notification stats will be tracked
          
          âš ï¸ **Note:** No emails were sent in preview mode
          EOF
          echo "- ðŸ”— Blog will be available at: https://listerineh.dev/blog/$BLOG_SLUG" >> $GITHUB_STEP_SUMMARY
